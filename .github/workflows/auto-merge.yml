# ğŸ”„ Auto-merge for Otogram
# Automatically merge dependabot PRs and other trusted automated PRs

name: "ğŸ”„ Auto Merge"

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: "ğŸ”„ Auto Merge Dependabot"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # Only run for dependabot PRs
    if: ${{ github.actor == 'dependabot[bot]' }}
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v4

    - name: "ğŸ” Dependabot metadata"
      id: metadata
      uses: dependabot/fetch-metadata@v2.0.0
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"

    - name: "âœ… Auto-approve Dependabot PR"
      # Auto-approve patch and minor updates for trusted packages
      if: ${{ steps.metadata.outputs.update-type == 'version-update:semver-patch' || (steps.metadata.outputs.update-type == 'version-update:semver-minor' && contains('pyrofork,python-telegram-bot,motor,pymongo,pydantic,loguru,aiofiles,python-dotenv,python-dateutil,apscheduler', steps.metadata.outputs.dependency-names)) }}
      run: gh pr review --approve "$PR_URL"
      env:
        PR_URL: ${{github.event.pull_request.html_url}}
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: "ğŸ”„ Enable auto-merge for Dependabot PR"
      # Auto-merge patch updates and trusted minor updates
      if: ${{ steps.metadata.outputs.update-type == 'version-update:semver-patch' || (steps.metadata.outputs.update-type == 'version-update:semver-minor' && contains('pyrofork,python-telegram-bot,motor,pymongo,pydantic,loguru,aiofiles,python-dotenv,python-dateutil,apscheduler', steps.metadata.outputs.dependency-names)) }}
      run: gh pr merge --auto --squash "$PR_URL"
      env:
        PR_URL: ${{github.event.pull_request.html_url}}
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: "ğŸ’¬ Comment on Major Updates"
      # Comment on major updates requiring manual review
      if: ${{ steps.metadata.outputs.update-type == 'version-update:semver-major' }}
      run: |
        gh pr comment "$PR_URL" --body "ğŸš¨ **Major version update detected!**
        
        This PR updates **${{ steps.metadata.outputs.dependency-names }}** with potentially breaking changes.
        
        **Action required:**
        - [ ] Review changelog for breaking changes
        - [ ] Test functionality thoroughly  
        - [ ] Update code if needed
        - [ ] Manual approval and merge required
        
        See: ${{ steps.metadata.outputs.dependency-urls }}"
      env:
        PR_URL: ${{github.event.pull_request.html_url}}
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

  # Auto-merge workflow files updates (if they pass CI/CD)
  auto-merge-workflows:
    name: "ğŸ”„ Auto Merge Workflow Updates"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    # Only run for PRs that only modify workflow files and pass all checks
    if: ${{ github.actor == 'dygje' && contains(github.event.pull_request.title, '[auto]') }}
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v4

    - name: "âœ… Auto-approve workflow updates"
      if: ${{ github.event.pull_request.user.login == 'dygje' }}
      run: gh pr review --approve "$PR_URL"
      env:
        PR_URL: ${{github.event.pull_request.html_url}}
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: "â³ Wait for CI to complete"
      uses: lewagon/wait-on-check-action@v1.3.3
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        check-name: 'âœ… CI Success'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        wait-interval: 10

    - name: "ğŸ”„ Enable auto-merge"
      run: gh pr merge --auto --squash "$PR_URL"
      env:
        PR_URL: ${{github.event.pull_request.html_url}}
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}