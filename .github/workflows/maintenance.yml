# ğŸ§¹ Repository Maintenance for Otogram
# Simple maintenance tasks to keep repository healthy

name: "ğŸ§¹ Maintenance"

on:
  schedule:
    # Run monthly on the 1st at 4 AM UTC
    - cron: '0 4 1 * *'
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: read
  actions: write

jobs:
  cleanup-artifacts:
    name: "ğŸ—‘ï¸ Cleanup Old Artifacts"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: "ğŸ—‘ï¸ Delete Old Workflow Artifacts"
      uses: actions/github-script@v7
      with:
        script: |
          // Get workflow runs older than 30 days
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          
          const { data: workflows } = await github.rest.actions.listRepoWorkflows({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          let deletedCount = 0;
          
          for (const workflow of workflows.workflows) {
            try {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow.id,
                status: 'completed',
                per_page: 100,
              });
              
              for (const run of runs.workflow_runs) {
                const runDate = new Date(run.created_at);
                if (runDate < thirtyDaysAgo) {
                  try {
                    await github.rest.actions.deleteWorkflowRun({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      run_id: run.id,
                    });
                    deletedCount++;
                    console.log(`Deleted workflow run: ${run.id}`);
                  } catch (error) {
                    console.log(`Could not delete run ${run.id}: ${error.message}`);
                  }
                }
              }
            } catch (error) {
              console.log(`Could not process workflow ${workflow.name}: ${error.message}`);
            }
          }
          
          console.log(`âœ… Cleanup completed. Deleted ${deletedCount} old workflow runs.`);

    - name: "ğŸ“‹ Generate Maintenance Report"
      run: |
        echo "ğŸ“‹ Monthly Maintenance Report - $(date)" > maintenance-report.md
        echo "=================================" >> maintenance-report.md
        echo "" >> maintenance-report.md
        echo "## ğŸ§¹ Maintenance Tasks Completed:" >> maintenance-report.md
        echo "- âœ… Old workflow runs cleaned up" >> maintenance-report.md
        echo "- âœ… Artifacts older than 30 days removed" >> maintenance-report.md
        echo "" >> maintenance-report.md
        echo "## ğŸ“Š Repository Health:" >> maintenance-report.md
        echo "- Total workflows: $(find .github/workflows -name '*.yml' | wc -l)" >> maintenance-report.md
        echo "- Latest commit: $(git log -1 --pretty=format:'%h - %s (%cr)')" >> maintenance-report.md
        echo "" >> maintenance-report.md
        echo "Generated by automated maintenance workflow ğŸ¤–" >> maintenance-report.md

    - name: "ğŸ“Š Upload Maintenance Report"
      uses: actions/upload-artifact@v4
      with:
        name: maintenance-report-${{ github.run_number }}
        path: maintenance-report.md
        retention-days: 90