# ğŸ›¡ï¸ Security Scanning for Otogram
# Comprehensive security analysis and vulnerability scanning

name: "ğŸ›¡ï¸ Security Scan"

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.py'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/security.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**/*.py'
      - 'pyproject.toml' 
      - 'requirements*.txt'
  schedule:
    # Run weekly security scan on Mondays at 8 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ğŸ” Python Security Scanning
  python-security:
    name: "ğŸ Python Security"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v4

    - name: "ğŸ Setup Python"
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: "ğŸ“¦ Install Security Tools"
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit semgrep

    - name: "ğŸ” Dependency Vulnerability Scan (Safety)"
      run: |
        # Install project dependencies
        pip install -e .
        # Create requirements for safety check
        pip freeze > temp_requirements.txt
        # Run safety check
        safety check -r temp_requirements.txt --json --output safety-report.json || true
        safety check -r temp_requirements.txt --short-report

    - name: "ğŸ”’ Static Security Analysis (Bandit)"
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ --severity-level medium --format screen

    - name: "âš¡ Advanced Security Scan (Semgrep)"
      run: |
        semgrep --config=auto src/ --json --output=semgrep-report.json || true
        semgrep --config=auto src/ --severity=ERROR

    - name: "ğŸ“Š Upload Security Reports"
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json
          semgrep-report.json
        retention-days: 30

  # ğŸ” Secret Scanning
  secret-scan:
    name: "ğŸ” Secret Detection"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better secret detection

    - name: "ğŸ” GitLeaks Secret Scan"
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}} # Optional for advanced features

    - name: "ğŸ” TruffleHog Secret Scan"
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  # ğŸ“Š OSSF Scorecard
  scorecard:
    name: "ğŸ“Š OSSF Scorecard"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v4
      with:
        persist-credentials: false

    - name: "ğŸ“Š Run OSSF Scorecard"
      uses: ossf/scorecard-action@v2.3.1
      with:
        results_file: results.sarif
        results_format: sarif
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        publish_results: true

    - name: "ğŸ“¤ Upload SARIF Results"
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif

  # ğŸ”§ Security Configuration Check
  config-security:
    name: "ğŸ”§ Config Security"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v4

    - name: "ğŸ” Check for Hardcoded Secrets"
      run: |
        echo "ğŸ” Scanning for potential hardcoded secrets..."
        
        # Check for common secret patterns
        if grep -r -i "password\s*=" src/ --include="*.py" | grep -v "# noqa" | grep -v "test"; then
          echo "âŒ Found potential hardcoded passwords"
          exit 1
        fi
        
        if grep -r -i "api[_-]key\s*=" src/ --include="*.py" | grep -v "# noqa" | grep -v "test"; then
          echo "âŒ Found potential hardcoded API keys"
          exit 1
        fi
        
        if grep -r -i "token\s*=" src/ --include="*.py" | grep -v "# noqa" | grep -v "test"; then
          echo "âŒ Found potential hardcoded tokens"
          exit 1
        fi
        
        echo "âœ… No obvious hardcoded secrets found"

    - name: "ğŸ” Check Environment Variable Usage"
      run: |
        echo "ğŸ” Checking proper environment variable usage..."
        
        # Ensure sensitive config uses environment variables
        python -c "
        import os
        from src.core.config import settings
        
        # Check that sensitive settings are using environment variables
        sensitive_vars = [
            'TELEGRAM_API_ID',
            'TELEGRAM_API_HASH', 
            'TELEGRAM_BOT_TOKEN',
            'TELEGRAM_PHONE_NUMBER'
        ]
        
        for var in sensitive_vars:
            if not hasattr(settings, var.replace('TELEGRAM_', '')):
                print(f'âŒ Missing config for {var}')
                exit(1)
        
        print('âœ… All sensitive configs properly configured')
        "

  # ğŸ“‹ Security Summary
  security-summary:
    name: "ğŸ“‹ Security Summary"
    runs-on: ubuntu-latest
    needs: [python-security, secret-scan, scorecard, config-security]
    if: always()
    timeout-minutes: 5
    
    steps:
    - name: "ğŸ“Š Security Scan Results"
      run: |
        echo "ğŸ›¡ï¸ Security Scan Summary for Otogram"
        echo "================================="
        echo ""
        echo "ğŸ“Š Scan Results:"
        echo "  ğŸ Python Security: ${{ needs.python-security.result }}"
        echo "  ğŸ” Secret Scan: ${{ needs.secret-scan.result }}"
        echo "  ğŸ“Š OSSF Scorecard: ${{ needs.scorecard.result }}"
        echo "  ğŸ”§ Config Security: ${{ needs.config-security.result }}"
        echo ""
        
        if [[ "${{ needs.python-security.result }}" == "success" && 
              "${{ needs.secret-scan.result }}" == "success" && 
              "${{ needs.scorecard.result }}" == "success" && 
              "${{ needs.config-security.result }}" == "success" ]]; then
          echo "âœ… All security scans passed!"
          echo "ğŸ›¡ï¸ Otogram security posture is good"
        else
          echo "âš ï¸  Some security scans failed or were skipped"
          echo "ğŸ” Please review the individual scan results"
        fi