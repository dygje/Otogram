# 🛡️ Security Scanning for Otogram
# Comprehensive security analysis and vulnerability scanning

name: "🛡️ Security Scan"

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.py'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/security.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**/*.py'
      - 'pyproject.toml' 
      - 'requirements*.txt'
  schedule:
    # Run weekly security scan on Mondays at 8 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # 🔍 Python Security Scanning
  python-security:
    name: "🐍 Python Security"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: "📥 Checkout Code"
      uses: actions/checkout@v4

    - name: "🐍 Setup Python"
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: "📦 Install Security Tools"
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit semgrep

    - name: "🔍 Dependency Vulnerability Scan (Safety)"
      run: |
        # Install project dependencies
        pip install -e .
        # Create requirements for safety check
        pip freeze > temp_requirements.txt
        # Run safety check
        safety check -r temp_requirements.txt --json --output safety-report.json || true
        safety check -r temp_requirements.txt --short-report

    - name: "🔒 Static Security Analysis (Bandit)"
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ --severity-level medium --format screen

    - name: "⚡ Advanced Security Scan (Semgrep)"
      run: |
        semgrep --config=auto src/ --json --output=semgrep-report.json || true
        semgrep --config=auto src/ --severity=ERROR

    - name: "📊 Upload Security Reports"
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json
          semgrep-report.json
        retention-days: 30

  # 🔐 Secret Scanning
  secret-scan:
    name: "🔐 Secret Detection"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: "📥 Checkout Code"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better secret detection

    - name: "🔍 GitLeaks Secret Scan"
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}} # Optional for advanced features

    - name: "🔐 TruffleHog Secret Scan"
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  # 📊 OSSF Scorecard
  scorecard:
    name: "📊 OSSF Scorecard"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read
    
    steps:
    - name: "📥 Checkout Code"
      uses: actions/checkout@v4
      with:
        persist-credentials: false

    - name: "📊 Run OSSF Scorecard"
      uses: ossf/scorecard-action@v2.3.1
      with:
        results_file: results.sarif
        results_format: sarif
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        publish_results: true

    - name: "📤 Upload SARIF Results"
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif

  # 🔧 Security Configuration Check
  config-security:
    name: "🔧 Config Security"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: "📥 Checkout Code"
      uses: actions/checkout@v4

    - name: "🔍 Check for Hardcoded Secrets"
      run: |
        echo "🔍 Scanning for potential hardcoded secrets..."
        
        # Check for common secret patterns
        if grep -r -i "password\s*=" src/ --include="*.py" | grep -v "# noqa" | grep -v "test"; then
          echo "❌ Found potential hardcoded passwords"
          exit 1
        fi
        
        if grep -r -i "api[_-]key\s*=" src/ --include="*.py" | grep -v "# noqa" | grep -v "test"; then
          echo "❌ Found potential hardcoded API keys"
          exit 1
        fi
        
        if grep -r -i "token\s*=" src/ --include="*.py" | grep -v "# noqa" | grep -v "test"; then
          echo "❌ Found potential hardcoded tokens"
          exit 1
        fi
        
        echo "✅ No obvious hardcoded secrets found"

    - name: "🔐 Check Environment Variable Usage"
      run: |
        echo "🔐 Checking proper environment variable usage..."
        
        # Ensure sensitive config uses environment variables
        python -c "
        import os
        from src.core.config import settings
        
        # Check that sensitive settings are using environment variables
        sensitive_vars = [
            'TELEGRAM_API_ID',
            'TELEGRAM_API_HASH', 
            'TELEGRAM_BOT_TOKEN',
            'TELEGRAM_PHONE_NUMBER'
        ]
        
        for var in sensitive_vars:
            if not hasattr(settings, var.replace('TELEGRAM_', '')):
                print(f'❌ Missing config for {var}')
                exit(1)
        
        print('✅ All sensitive configs properly configured')
        "

  # 📋 Security Summary
  security-summary:
    name: "📋 Security Summary"
    runs-on: ubuntu-latest
    needs: [python-security, secret-scan, scorecard, config-security]
    if: always()
    timeout-minutes: 5
    
    steps:
    - name: "📊 Security Scan Results"
      run: |
        echo "🛡️ Security Scan Summary for Otogram"
        echo "================================="
        echo ""
        echo "📊 Scan Results:"
        echo "  🐍 Python Security: ${{ needs.python-security.result }}"
        echo "  🔐 Secret Scan: ${{ needs.secret-scan.result }}"
        echo "  📊 OSSF Scorecard: ${{ needs.scorecard.result }}"
        echo "  🔧 Config Security: ${{ needs.config-security.result }}"
        echo ""
        
        if [[ "${{ needs.python-security.result }}" == "success" && 
              "${{ needs.secret-scan.result }}" == "success" && 
              "${{ needs.scorecard.result }}" == "success" && 
              "${{ needs.config-security.result }}" == "success" ]]; then
          echo "✅ All security scans passed!"
          echo "🛡️ Otogram security posture is good"
        else
          echo "⚠️  Some security scans failed or were skipped"
          echo "🔍 Please review the individual scan results"
        fi