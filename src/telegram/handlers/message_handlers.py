"""
Message Handlers - Modern message management interface
Enhanced with 2025 UI/UX best practices for optimal user experience
"""

from loguru import logger

from src.core.constants import (
    MAX_MESSAGES_DISPLAY,
    PREVIEW_MESSAGE_LENGTH,
    PREVIEW_MESSAGE_LENGTH_LONG,
    PREVIEW_MESSAGE_LENGTH_SHORT,
    TELEGRAM_MESSAGE_MAX_LENGTH,
)
from src.models.message import MessageCreate
from src.services.message_service import MessageService
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.ext import ContextTypes


class MessageHandlers:
    """Modern handlers for message management with enhanced UX"""

    def __init__(self) -> None:
        self.message_service = MessageService()

    async def list_messages(self, update: Update, _context: ContextTypes.DEFAULT_TYPE) -> None:
        """Enhanced message listing with modern design"""
        try:
            messages = await self.message_service.get_all_messages()
            stats = await self.message_service.get_message_count()

            if not messages:
                text = (
                    "üìù **MESSAGE MANAGEMENT CENTER**\n"
                    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                    "üì≠ **No Messages Found**\n\n"
                    "üöÄ **Get Started:**\n\n"
                    "**Step 1:** Create your first broadcast message\n"
                    "‚îú Click **'Add Message'** below\n"
                    "‚îú Write engaging content for your audience\n"
                    "‚îî Save and activate for broadcasting\n\n"
                    "**Step 2:** Configure target groups\n"
                    "‚îú Add groups that should receive messages\n"
                    "‚îî System will handle delivery automatically\n\n"
                    "üí° **Pro Tip:** Start with 1-2 messages to test the system!"
                )
                keyboard = [
                    [InlineKeyboardButton("‚ûï Create First Message", callback_data="messages_add")],
                    [
                        InlineKeyboardButton(
                            "üìö Message Tutorial", callback_data="tutorial_messages"
                        ),
                        InlineKeyboardButton("üè† Dashboard", callback_data="dashboard"),
                    ],
                ]
            else:
                # Calculate utilization rate
                active_rate = (stats["active"] / stats["total"] * 100) if stats["total"] > 0 else 0
                health_indicator = "üü¢" if stats["active"] > 0 else "üî¥"

                text = (
                    f"üìù **MESSAGE MANAGEMENT CENTER**\n"
                    f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                    f"üìä **Collection Overview:**\n"
                    f"‚îú Status: {health_indicator} {'Ready for Broadcasting' if stats['active'] > 0 else 'Setup Required'}\n"
                    f"‚îú Total Messages: **{stats['total']}** in collection\n"
                    f"‚îú Active Messages: **{stats['active']}** ({active_rate:.0f}% utilization)\n"
                    f"‚îú Inactive Messages: **{stats['inactive']}** (paused)\n"
                    f"‚îî Broadcasting Ready: {'‚úÖ Yes' if stats['active'] > 0 else '‚ùå Needs Active Messages'}\n\n"
                    f"üìã **Message Library:**\n"
                )

                keyboard = []
                # Show messages with better formatting
                for i, msg in enumerate(messages[:MAX_MESSAGES_DISPLAY], 1):
                    status_icon = "üü¢" if msg.is_active else "‚ö™"
                    usage_indicator = f"üìä {msg.usage_count}x" if msg.usage_count > 0 else "üìä New"

                    content_preview = (
                        msg.content[:PREVIEW_MESSAGE_LENGTH] + "..."
                        if len(msg.content) > PREVIEW_MESSAGE_LENGTH
                        else msg.content
                    )

                    text += f"**{i}.** {status_icon} *{content_preview}*\n"
                    text += f"   {usage_indicator} ‚Ä¢ ID: `{msg.id[:8]}...`\n\n"

                    # Add edit buttons in pairs for better layout
                    if i % 2 == 1:  # Start new row for odd numbers
                        keyboard.append(
                            [
                                InlineKeyboardButton(
                                    f"‚úèÔ∏è Edit #{i}", callback_data=f"messages_edit_{msg.id}"
                                ),
                            ]
                        )
                    else:  # Add to existing row for even numbers
                        keyboard[-1].append(
                            InlineKeyboardButton(
                                f"‚úèÔ∏è Edit #{i}", callback_data=f"messages_edit_{msg.id}"
                            )
                        )

                if len(messages) > MAX_MESSAGES_DISPLAY:
                    remaining = len(messages) - MAX_MESSAGES_DISPLAY
                    text += f"   ‚ãÆ *{remaining} more messages in collection...*\n"

                # Add management buttons
                keyboard.extend(
                    [
                        [
                            InlineKeyboardButton("‚ûï Add Message", callback_data="messages_add"),
                            InlineKeyboardButton("üîÑ Bulk Actions", callback_data="messages_bulk"),
                        ],
                        [
                            InlineKeyboardButton(
                                "üìä Usage Analytics", callback_data="messages_analytics"
                            ),
                            InlineKeyboardButton(
                                "‚öôÔ∏è Advanced Options", callback_data="messages_advanced"
                            ),
                        ],
                    ]
                )

            keyboard.append(
                [
                    InlineKeyboardButton("üè† Dashboard", callback_data="dashboard"),
                    InlineKeyboardButton("üîÑ Refresh", callback_data="messages_menu"),
                ]
            )
            reply_markup = InlineKeyboardMarkup(keyboard)

            if update.message:
                await update.message.reply_text(
                    text, parse_mode="Markdown", reply_markup=reply_markup
                )
            elif update.callback_query:
                await update.callback_query.edit_message_text(
                    text, parse_mode="Markdown", reply_markup=reply_markup
                )

        except Exception as e:
            logger.error(f"Error listing messages: {e}")
            await self._send_error_message(update, "Failed to load message collection")

    async def add_message_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """Enhanced add message interface"""
        text = (
            "‚ûï **CREATE NEW BROADCAST MESSAGE**\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            "üìù **Content Guidelines:**\n\n"
            "‚úÖ **What to Include:**\n"
            "‚îú Clear, engaging message content\n"
            "‚îú Call-to-action if needed\n"
            "‚îú Relevant information for your audience\n"
            "‚îî Professional formatting\n\n"
            "üìè **Technical Requirements:**\n"
            "‚îú **Format:** Text only (no media)\n"
            "‚îú **Length:** Maximum 4,096 characters\n"
            "‚îú **Encoding:** UTF-8 (supports emojis)\n"
            "‚îî **Status:** Auto-activated upon creation\n\n"
            "üí° **Pro Tips:**\n"
            "‚Ä¢ Keep messages concise and focused\n"
            "‚Ä¢ Use formatting (*bold*, _italic_) for emphasis\n"
            "‚Ä¢ Test with a small group first\n"
            "‚Ä¢ Consider your audience's timezone\n\n"
            "‚úçÔ∏è **Ready to create?**\n"
            "Type your message content and send it in the next message:"
        )

        if context.user_data:
            context.user_data["waiting_for"] = "message_content"

        keyboard = [
            [
                InlineKeyboardButton("‚ùå Cancel", callback_data="messages_menu"),
                InlineKeyboardButton("üìö Tips & Examples", callback_data="messages_help"),
            ]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        if update.message:
            await update.message.reply_text(text, parse_mode="Markdown", reply_markup=reply_markup)

    async def handle_message_input(
        self, update: Update, context: ContextTypes.DEFAULT_TYPE
    ) -> None:
        """Enhanced message input handling with validation"""
        try:
            if update.message and update.message.text:
                content = update.message.text.strip()
            else:
                await update.message.reply_text(
                    "‚ùå **Invalid Input**\n\n"
                    "Please send a text message with your content.\n"
                    "Media messages are not supported for broadcasting."
                ) if update.message else None
                return

            # Enhanced validation
            if not content:
                await update.message.reply_text(
                    "‚ùå **Empty Message**\n\n"
                    "Your message content cannot be empty.\n"
                    "Please write your broadcast message and try again."
                ) if update.message else None
                return

            if len(content) > TELEGRAM_MESSAGE_MAX_LENGTH:
                await update.message.reply_text(
                    f"‚ùå **Message Too Long**\n\n"
                    f"**Current Length:** {len(content):,} characters\n"
                    f"**Maximum Allowed:** {TELEGRAM_MESSAGE_MAX_LENGTH:,} characters\n"
                    f"**Excess:** {len(content) - TELEGRAM_MESSAGE_MAX_LENGTH:,} characters\n\n"
                    f"Please shorten your message and try again."
                ) if update.message else None
                return

            # Show processing message
            processing_msg = (
                await update.message.reply_text(
                    "‚è≥ **CREATING MESSAGE**\n"
                    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                    "üìù Processing your message...\n"
                    "‚ö° Validating content and format...\n\n"
                    "Please wait a moment..."
                )
                if update.message
                else None
            )

            # Create message
            message_data = MessageCreate(content=content)
            message = await self.message_service.create_message(message_data)

            # Clear waiting state
            if context.user_data:
                context.user_data.pop("waiting_for", None)

            # Calculate message metrics
            word_count = len(content.split())
            line_count = len(content.split("\n"))
            char_utilization = (len(content) / TELEGRAM_MESSAGE_MAX_LENGTH) * 100

            success_text = (
                f"‚úÖ **MESSAGE CREATED SUCCESSFULLY!**\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                f"üéâ **Your broadcast message is ready!**\n\n"
                f"üìä **Message Details:**\n"
                f"‚îú **ID:** `{message.id}`\n"
                f"‚îú **Length:** {len(content):,} characters ({char_utilization:.1f}% of limit)\n"
                f"‚îú **Words:** {word_count:,} words\n"
                f"‚îú **Lines:** {line_count} lines\n"
                f"‚îú **Created:** {message.created_at.strftime('%d/%m/%Y at %H:%M')}\n"
                f"‚îú **Status:** üü¢ **Active & Ready**\n"
                f"‚îî **Usage:** üìä Ready for broadcasting\n\n"
                f"üìù **Content Preview:**\n"
                f"*{content[:PREVIEW_MESSAGE_LENGTH_SHORT]}{'...' if len(content) > PREVIEW_MESSAGE_LENGTH_SHORT else ''}*\n\n"
                f"üöÄ **What's Next:**\n"
                f"‚Ä¢ Your message is automatically activated\n"
                f"‚Ä¢ Add target groups for broadcasting\n"
                f"‚Ä¢ Configure system settings if needed\n"
                f"‚Ä¢ Start broadcasting from the dashboard!"
            )

            keyboard = [
                [
                    InlineKeyboardButton("üìù View All Messages", callback_data="messages_menu"),
                    InlineKeyboardButton("‚ûï Add Another", callback_data="messages_add"),
                ],
                [
                    InlineKeyboardButton("üë• Add Groups", callback_data="groups_dashboard"),
                    InlineKeyboardButton("üöÄ Start Broadcasting", callback_data="dashboard"),
                ],
                [
                    InlineKeyboardButton(
                        "‚úèÔ∏è Edit This Message", callback_data=f"messages_edit_{message.id}"
                    ),
                    InlineKeyboardButton("üè† Dashboard", callback_data="dashboard"),
                ],
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            if processing_msg:
                await processing_msg.edit_text(
                    success_text, parse_mode="Markdown", reply_markup=reply_markup
                )
            elif update.message:
                await update.message.reply_text(
                    success_text, parse_mode="Markdown", reply_markup=reply_markup
                )

        except Exception as e:
            logger.error(f"Error adding message: {e}")
            if context.user_data:
                context.user_data.pop("waiting_for", None)
            await self._send_error_message(update, "Failed to create message")

    async def handle_callback(
        self, update: Update, context: ContextTypes.DEFAULT_TYPE, data: str
    ) -> None:
        """Enhanced callback handling with comprehensive routing"""
        if data == "messages_menu":
            await self.list_messages(update, context)
        elif data == "messages_add":
            await self._show_add_message_prompt(update, context)
        elif data == "messages_bulk":
            await self._show_bulk_actions(update, context)
        elif data == "messages_analytics":
            await self._show_message_analytics(update, context)
        elif data == "messages_advanced":
            await self._show_advanced_options(update, context)
        elif data == "messages_help":
            await self._show_message_help(update, context)
        elif data.startswith("messages_edit_"):
            message_id = data.replace("messages_edit_", "")
            await self._show_edit_message(update, message_id)
        elif data.startswith("messages_toggle_"):
            message_id = data.replace("messages_toggle_", "")
            await self._toggle_message_status(update, message_id)
        elif data.startswith("messages_delete_"):
            message_id = data.replace("messages_delete_", "")
            await self._confirm_delete_message(update, message_id)
        elif data.startswith("messages_delete_confirm_"):
            message_id = data.replace("messages_delete_confirm_", "")
            await self._delete_message(update, message_id)
        elif data.startswith("messages_duplicate_"):
            message_id = data.replace("messages_duplicate_", "")
            await self._duplicate_message(update, message_id)

    async def _show_add_message_prompt(
        self, update: Update, context: ContextTypes.DEFAULT_TYPE
    ) -> None:
        """Enhanced add message prompt with better guidance"""
        text = (
            "‚ûï **CREATE NEW BROADCAST MESSAGE**\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            "üìù **Message Composition:**\n\n"
            "**Content Guidelines:**\n"
            "‚îú Write clear, engaging content\n"
            "‚îú Use proper formatting for readability\n"
            "‚îú Include relevant call-to-actions\n"
            "‚îî Keep your audience in mind\n\n"
            "**Technical Limits:**\n"
            "‚îú Maximum: 4,096 characters\n"
            "‚îú Format: Text only (no media)\n"
            "‚îú Encoding: Full Unicode support\n"
            "‚îî Status: Auto-activated when saved\n\n"
            "‚úçÔ∏è **Type your message content in the next message:**"
        )

        keyboard = [
            [
                InlineKeyboardButton("‚ùå Cancel", callback_data="messages_menu"),
                InlineKeyboardButton("üí° Writing Tips", callback_data="messages_help"),
            ]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        if update.callback_query:
            await update.callback_query.edit_message_text(
                text, parse_mode="Markdown", reply_markup=reply_markup
            )

        if context.user_data:
            context.user_data["waiting_for"] = "message_content"

    async def _show_edit_message(self, update: Update, message_id: str) -> None:
        """Enhanced message editing interface"""
        try:
            message = await self.message_service.get_message_by_id(message_id)

            if not message:
                if update.callback_query:
                    await update.callback_query.edit_message_text(
                        "‚ùå **Message Not Found**\n\n"
                        "The requested message could not be located.\n"
                        "It may have been deleted or the ID is invalid."
                    )
                return

            # Calculate message metrics
            word_count = len(message.content.split())
            line_count = len(message.content.split("\n"))
            char_utilization = (len(message.content) / TELEGRAM_MESSAGE_MAX_LENGTH) * 100
            status_text = "üü¢ **Active**" if message.is_active else "‚ö™ **Inactive**"

            content_preview = (
                message.content[:PREVIEW_MESSAGE_LENGTH_LONG] + "..."
                if len(message.content) > PREVIEW_MESSAGE_LENGTH_LONG
                else message.content
            )

            text = (
                f"‚úèÔ∏è **MESSAGE EDITOR**\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                f"üìä **Message Information:**\n"
                f"‚îú **ID:** `{message.id}`\n"
                f"‚îú **Status:** {status_text}\n"
                f"‚îú **Length:** {len(message.content):,} chars ({char_utilization:.1f}% of limit)\n"
                f"‚îú **Words:** {word_count:,} words\n"
                f"‚îú **Lines:** {line_count} lines\n"
                f"‚îú **Usage Count:** üìä {message.usage_count} broadcasts\n"
                f"‚îú **Created:** {message.created_at.strftime('%d/%m/%Y at %H:%M')}\n"
                f"‚îî **Last Modified:** {message.updated_at.strftime('%d/%m/%Y at %H:%M') if message.updated_at else 'Never'}\n\n"
                f"üìù **Content Preview:**\n"
                f"*{content_preview}*\n\n"
                f"üõ†Ô∏è **Available Actions:**"
            )

            keyboard = [
                [
                    InlineKeyboardButton(
                        "‚ö™ Deactivate" if message.is_active else "üü¢ Activate",
                        callback_data=f"messages_toggle_{message_id}",
                    ),
                    InlineKeyboardButton(
                        "üìã Duplicate", callback_data=f"messages_duplicate_{message_id}"
                    ),
                ],
                [
                    InlineKeyboardButton(
                        "üìä View Analytics", callback_data=f"messages_analytics_{message_id}"
                    ),
                    InlineKeyboardButton(
                        "üìù View Full Content", callback_data=f"messages_view_{message_id}"
                    ),
                ],
                [
                    InlineKeyboardButton(
                        "üóëÔ∏è Delete Message", callback_data=f"messages_delete_{message_id}"
                    ),
                    InlineKeyboardButton(
                        "üîÑ Refresh Info", callback_data=f"messages_edit_{message_id}"
                    ),
                ],
                [
                    InlineKeyboardButton("üîô Back to List", callback_data="messages_menu"),
                    InlineKeyboardButton("üè† Dashboard", callback_data="dashboard"),
                ],
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            if update.callback_query:
                await update.callback_query.edit_message_text(
                    text, parse_mode="Markdown", reply_markup=reply_markup
                )

        except Exception as e:
            logger.error(f"Error showing edit message: {e}")
            if update.callback_query:
                await update.callback_query.edit_message_text(
                    "‚ùå **Error Loading Message**\n\n"
                    "Unable to load message details.\n"
                    "Please try again or check if the message still exists."
                )

    async def _show_bulk_actions(self, update: Update, _context: ContextTypes.DEFAULT_TYPE) -> None:
        """Enhanced bulk actions interface"""
        try:
            stats = await self.message_service.get_message_count()

            text = (
                f"üîÑ **BULK MESSAGE ACTIONS**\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                f"üìä **Current Collection:**\n"
                f"‚îú Total Messages: {stats['total']}\n"
                f"‚îú Active Messages: {stats['active']}\n"
                f"‚îú Inactive Messages: {stats['inactive']}\n"
                f"‚îî Ready for Actions: {'‚úÖ Yes' if stats['total'] > 0 else '‚ùå No Messages'}\n\n"
                f"üõ†Ô∏è **Available Bulk Operations:**\n\n"
                f"**Status Management:**\n"
                f"‚îú Activate all messages for broadcasting\n"
                f"‚îú Deactivate all messages (pause)\n"
                f"‚îî Toggle status of selected messages\n\n"
                f"**Collection Management:**\n"
                f"‚îú Export message collection\n"
                f"‚îú Import messages from file\n"
                f"‚îú Clear usage statistics\n"
                f"‚îî Optimize message storage\n\n"
                f"**Maintenance Operations:**\n"
                f"‚îú Remove duplicate messages\n"
                f"‚îú Clean up unused messages\n"
                f"‚îî Validate all message content\n\n"
                f"‚ö†Ô∏è **Note:** Bulk operations affect multiple messages at once."
            )

            keyboard = [
                [
                    InlineKeyboardButton("üü¢ Activate All", callback_data="messages_bulk_activate"),
                    InlineKeyboardButton(
                        "‚ö™ Deactivate All", callback_data="messages_bulk_deactivate"
                    ),
                ],
                [
                    InlineKeyboardButton(
                        "üìä Clear Statistics", callback_data="messages_bulk_clear_stats"
                    ),
                    InlineKeyboardButton(
                        "üßπ Remove Duplicates", callback_data="messages_bulk_dedupe"
                    ),
                ],
                [
                    InlineKeyboardButton(
                        "üì§ Export Collection", callback_data="messages_bulk_export"
                    ),
                    InlineKeyboardButton(
                        "üì• Import Messages", callback_data="messages_bulk_import"
                    ),
                ],
                [
                    InlineKeyboardButton("üîô Back to Messages", callback_data="messages_menu"),
                    InlineKeyboardButton("üè† Dashboard", callback_data="dashboard"),
                ],
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            if update.callback_query:
                await update.callback_query.edit_message_text(
                    text, parse_mode="Markdown", reply_markup=reply_markup
                )

        except Exception as e:
            logger.error(f"Error showing bulk actions: {e}")
            if update.callback_query:
                await update.callback_query.edit_message_text(
                    "‚ùå Error loading bulk actions interface"
                )

    async def _show_message_analytics(
        self, update: Update, _context: ContextTypes.DEFAULT_TYPE
    ) -> None:
        """Enhanced message analytics dashboard"""
        try:
            messages = await self.message_service.get_all_messages()
            stats = await self.message_service.get_message_count()

            if not messages:
                text = (
                    "üìä **MESSAGE ANALYTICS**\n"
                    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                    "üì≠ **No Data Available**\n\n"
                    "Create some messages first to see analytics data.\n"
                    "Analytics will show usage patterns, performance metrics, and optimization suggestions."
                )
                keyboard = [
                    [InlineKeyboardButton("‚ûï Create Messages", callback_data="messages_add")],
                    [InlineKeyboardButton("üîô Back", callback_data="messages_menu")],
                ]
            else:
                # Calculate analytics
                total_usage = sum(msg.usage_count for msg in messages)
                avg_usage = total_usage / len(messages) if messages else 0
                most_used = max(messages, key=lambda x: x.usage_count) if messages else None
                active_rate = (stats["active"] / stats["total"] * 100) if stats["total"] > 0 else 0

                # Content analysis
                total_chars = sum(len(msg.content) for msg in messages)
                avg_length = total_chars / len(messages) if messages else 0

                text = (
                    f"üìä **MESSAGE ANALYTICS DASHBOARD**\n"
                    f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                    f"üìà **Performance Metrics:**\n"
                    f"‚îú Collection Size: {len(messages)} messages\n"
                    f"‚îú Total Broadcasts: {total_usage:,} sends\n"
                    f"‚îú Average Usage: {avg_usage:.1f} sends per message\n"
                    f"‚îú Activation Rate: {active_rate:.1f}% active\n"
                    f"‚îî Efficiency Score: {min(100, active_rate + (avg_usage * 10)):.0f}/100\n\n"
                    f"üìù **Content Analysis:**\n"
                    f"‚îú Average Length: {avg_length:.0f} characters\n"
                    f"‚îú Total Characters: {total_chars:,} chars\n"
                    f"‚îú Content Variety: {'High' if len(set(msg.content[:50] for msg in messages)) > len(messages) * 0.8 else 'Medium'}\n"
                    f"‚îî Optimization Level: {'Good' if avg_length < 1000 else 'Needs Review'}\n\n"
                )

                if most_used and most_used.usage_count > 0:
                    text += (
                        f"üèÜ **Top Performer:**\n"
                        f"‚îú Message: *{most_used.content[:50]}...*\n"
                        f"‚îú Usage: {most_used.usage_count} broadcasts\n"
                        f"‚îî Status: {'üü¢ Active' if most_used.is_active else '‚ö™ Inactive'}\n\n"
                    )

                text += (
                    f"üí° **Recommendations:**\n"
                    f"‚Ä¢ {'Create more active messages' if stats['active'] < 3 else 'Good message variety'}\n"
                    f"‚Ä¢ {'Review inactive messages' if stats['inactive'] > stats['active'] else 'Good activation rate'}\n"
                    f"‚Ä¢ {'Consider shorter messages' if avg_length > 1500 else 'Good message length'}"
                )

                keyboard = [
                    [
                        InlineKeyboardButton(
                            "üìà Detailed Report", callback_data="messages_analytics_detailed"
                        ),
                        InlineKeyboardButton("üîÑ Refresh Data", callback_data="messages_analytics"),
                    ],
                    [
                        InlineKeyboardButton(
                            "üìä Export Report", callback_data="messages_analytics_export"
                        ),
                        InlineKeyboardButton(
                            "üí° Optimization Tips", callback_data="messages_optimization"
                        ),
                    ],
                    [
                        InlineKeyboardButton("üîô Back to Messages", callback_data="messages_menu"),
                        InlineKeyboardButton("üè† Dashboard", callback_data="dashboard"),
                    ],
                ]

            reply_markup = InlineKeyboardMarkup(keyboard)

            if update.callback_query:
                await update.callback_query.edit_message_text(
                    text, parse_mode="Markdown", reply_markup=reply_markup
                )

        except Exception as e:
            logger.error(f"Error showing message analytics: {e}")
            if update.callback_query:
                await update.callback_query.edit_message_text("‚ùå Error loading analytics data")

    async def _show_message_help(self, update: Update, _context: ContextTypes.DEFAULT_TYPE) -> None:
        """Enhanced message help and writing tips"""
        text = (
            "üí° **MESSAGE WRITING GUIDE**\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            "‚úçÔ∏è **Effective Message Writing:**\n\n"
            "**üéØ Content Strategy:**\n"
            "‚îú Start with a compelling hook\n"
            "‚îú Keep your main message clear and concise\n"
            "‚îú Include a specific call-to-action\n"
            "‚îî End with value or benefit statement\n\n"
            "**üìù Formatting Best Practices:**\n"
            "‚îú Use **bold** for important points\n"
            "‚îú Use *italics* for emphasis\n"
            "‚îú Use `code` for technical terms\n"
            "‚îú Break text into readable paragraphs\n"
            "‚îî Use emojis sparingly for engagement\n\n"
            "**üìè Length Guidelines:**\n"
            "‚îú **Short Messages (< 500 chars):** Quick announcements\n"
            "‚îú **Medium Messages (500-1500 chars):** Detailed updates\n"
            "‚îú **Long Messages (1500+ chars):** Comprehensive content\n"
            "‚îî **Maximum Limit:** 4,096 characters\n\n"
            "**‚ö° Engagement Tips:**\n"
            "‚îú Ask questions to encourage interaction\n"
            "‚îú Use urgency words when appropriate\n"
            "‚îú Personalize content for your audience\n"
            "‚îú Include relevant hashtags or keywords\n"
            "‚îî Test different message styles\n\n"
            "**üö´ What to Avoid:**\n"
            "‚îú Excessive capitalization (LOOKS LIKE SHOUTING)\n"
            "‚îú Too many emojis in one message\n"
            "‚îú Unclear or vague calls-to-action\n"
            "‚îú Grammar and spelling errors\n"
            "‚îî Overly promotional language\n\n"
            "**üìä Performance Optimization:**\n"
            "‚îú Monitor which messages get the best response\n"
            "‚îú A/B test different versions\n"
            "‚îú Adapt content based on audience feedback\n"
            "‚îî Update messages based on analytics\n\n"
            "**üí° Pro Tips:**\n"
            "‚Ä¢ Write like you're talking to a friend\n"
            "‚Ä¢ Use active voice instead of passive\n"
            "‚Ä¢ Focus on benefits, not just features\n"
            "‚Ä¢ Keep sentences short and punchy\n"
            "‚Ä¢ End with a clear next step"
        )

        keyboard = [
            [
                InlineKeyboardButton("‚úçÔ∏è Start Writing", callback_data="messages_add"),
                InlineKeyboardButton("üìä See Examples", callback_data="messages_examples"),
            ],
            [
                InlineKeyboardButton("üîô Back to Messages", callback_data="messages_menu"),
                InlineKeyboardButton("üè† Dashboard", callback_data="dashboard"),
            ],
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        if update.callback_query:
            await update.callback_query.edit_message_text(
                text, parse_mode="Markdown", reply_markup=reply_markup
            )

    async def _confirm_delete_message(self, update: Update, message_id: str) -> None:
        """Enhanced delete confirmation with safety checks"""
        try:
            message = await self.message_service.get_message_by_id(message_id)

            if not message:
                if update.callback_query:
                    await update.callback_query.edit_message_text(
                        "‚ùå **Message Not Found**\n\n"
                        "The message you're trying to delete could not be found.\n"
                        "It may have already been deleted."
                    )
                return

            # Safety information
            preview = (
                message.content[:100] + "..." if len(message.content) > 100 else message.content
            )
            usage_warning = (
                f"‚ö†Ô∏è This message has been used {message.usage_count} times"
                if message.usage_count > 0
                else ""
            )

            text = (
                f"üóëÔ∏è **CONFIRM MESSAGE DELETION**\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                f"‚ö†Ô∏è **Permanent Action Warning**\n\n"
                f"**Message to Delete:**\n"
                f"‚îú ID: `{message.id}`\n"
                f"‚îú Status: {'üü¢ Active' if message.is_active else '‚ö™ Inactive'}\n"
                f"‚îú Usage: üìä {message.usage_count} broadcasts\n"
                f"‚îú Created: {message.created_at.strftime('%d/%m/%Y')}\n"
                f"‚îî Length: {len(message.content):,} characters\n\n"
                f"üìù **Preview:**\n"
                f"*{preview}*\n\n"
                f"{usage_warning}\n\n"
                if usage_warning
                else ""
                "üö® **This action cannot be undone!**\n\n"
                "**Consequences:**\n"
                "‚îú Message will be permanently removed\n"
                "‚îú All usage statistics will be lost\n"
                "‚îú Cannot be recovered after deletion\n"
                "‚îî Broadcasting system will be updated\n\n"
                "**Are you absolutely sure you want to proceed?**"
            )

            keyboard = [
                [
                    InlineKeyboardButton(
                        "üóëÔ∏è DELETE PERMANENTLY",
                        callback_data=f"messages_delete_confirm_{message_id}",
                    ),
                ],
                [
                    InlineKeyboardButton("‚ùå Cancel", callback_data=f"messages_edit_{message_id}"),
                    InlineKeyboardButton("üîô Back to List", callback_data="messages_menu"),
                ],
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            if update.callback_query:
                await update.callback_query.edit_message_text(
                    text, parse_mode="Markdown", reply_markup=reply_markup
                )

        except Exception as e:
            logger.error(f"Error confirming delete message: {e}")
            if update.callback_query:
                await update.callback_query.edit_message_text(
                    "‚ùå Error loading deletion confirmation"
                )

    async def _delete_message(self, update: Update, message_id: str) -> None:
        """Enhanced message deletion with confirmation"""
        try:
            success = await self.message_service.delete_message(message_id)

            if success:
                text = (
                    "‚úÖ **MESSAGE DELETED SUCCESSFULLY**\n"
                    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                    "üóëÔ∏è **Deletion Complete**\n\n"
                    "**What Happened:**\n"
                    "‚îú Message permanently removed from collection\n"
                    "‚îú All associated statistics cleared\n"
                    "‚îú Broadcasting system updated\n"
                    "‚îî Storage space optimized\n\n"
                    "**Next Steps:**\n"
                    "‚Ä¢ Review your remaining messages\n"
                    "‚Ä¢ Consider creating replacement content\n"
                    "‚Ä¢ Update your broadcasting strategy\n\n"
                    "üí° **Tip:** Maintain a diverse message collection for better engagement!"
                )
            else:
                text = (
                    "‚ùå **DELETION FAILED**\n"
                    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                    "‚ö†Ô∏è **Unable to Delete Message**\n\n"
                    "**Possible Causes:**\n"
                    "‚îú Message no longer exists\n"
                    "‚îú Database connection issue\n"
                    "‚îú System protection mechanism\n"
                    "‚îî Temporary server error\n\n"
                    "**Try Again:**\n"
                    "‚Ä¢ Refresh the message list\n"
                    "‚Ä¢ Check if message still exists\n"
                    "‚Ä¢ Contact support if issue persists"
                )

            keyboard = [
                [
                    InlineKeyboardButton("üìù View Messages", callback_data="messages_menu"),
                    InlineKeyboardButton("‚ûï Add New Message", callback_data="messages_add"),
                ],
                [InlineKeyboardButton("üè† Dashboard", callback_data="dashboard")],
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            if update.callback_query:
                await update.callback_query.edit_message_text(
                    text, parse_mode="Markdown", reply_markup=reply_markup
                )

        except Exception as e:
            logger.error(f"Error deleting message: {e}")
            if update.callback_query:
                await update.callback_query.edit_message_text(
                    "‚ùå **System Error**\n\n"
                    "Failed to delete message due to system error.\n"
                    "Please try again or contact support."
                )

    async def _toggle_message_status(self, update: Update, message_id: str) -> None:
        """Enhanced message status toggle with feedback"""
        try:
            updated_message = await self.message_service.toggle_message_status(message_id)

            if updated_message:
                status_action = "activated" if updated_message.is_active else "deactivated"
                status_icon = "üü¢" if updated_message.is_active else "‚ö™"

                text = (
                    f"‚úÖ **MESSAGE {status_action.upper()}**\n"
                    f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                    f"{status_icon} **Status Update Complete**\n\n"
                    f"**Message Details:**\n"
                    f"‚îú ID: `{updated_message.id}`\n"
                    f"‚îú New Status: {status_icon} **{status_action.title()}**\n"
                    f"‚îú Usage Count: üìä {updated_message.usage_count} broadcasts\n"
                    f"‚îî Broadcasting: {'‚úÖ Enabled' if updated_message.is_active else '‚ö™ Paused'}\n\n"
                    f"**Impact:**\n"
                    f"{'‚Ä¢ Message is now available for broadcasting' if updated_message.is_active else '‚Ä¢ Message will not be used in broadcasts'}\n"
                    f"{'‚Ä¢ Will be included in rotation cycles' if updated_message.is_active else '‚Ä¢ Excluded from rotation cycles'}\n"
                    f"{'‚Ä¢ Contributes to automation goals' if updated_message.is_active else '‚Ä¢ Temporarily paused from system'}\n\n"
                    f"üí° **Tip:** {'Deactivate messages temporarily if you want to pause specific content' if updated_message.is_active else 'Reactivate when ready to resume using this message'}"
                )
            else:
                text = (
                    "‚ùå **STATUS UPDATE FAILED**\n"
                    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                    "‚ö†Ô∏è **Unable to Update Message**\n\n"
                    "**Possible Issues:**\n"
                    "‚îú Message no longer exists\n"
                    "‚îú Database synchronization error\n"
                    "‚îú Temporary system issue\n"
                    "‚îî Insufficient permissions\n\n"
                    "**Next Steps:**\n"
                    "‚Ä¢ Refresh the message list\n"
                    "‚Ä¢ Try the operation again\n"
                    "‚Ä¢ Check system status\n"
                    "‚Ä¢ Contact support if issue persists"
                )

            keyboard = [
                [
                    InlineKeyboardButton("üîÑ Refresh List", callback_data="messages_menu"),
                    InlineKeyboardButton(
                        "‚úèÔ∏è Edit Message", callback_data=f"messages_edit_{message_id}"
                    ),
                ],
                [InlineKeyboardButton("üè† Dashboard", callback_data="dashboard")],
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            if update.callback_query:
                await update.callback_query.edit_message_text(
                    text, parse_mode="Markdown", reply_markup=reply_markup
                )

        except Exception as e:
            logger.error(f"Error toggling message status: {e}")
            if update.callback_query:
                await update.callback_query.edit_message_text(
                    "‚ùå **System Error**\n\n"
                    "Failed to update message status.\n"
                    "Please try again later."
                )

    async def _duplicate_message(self, update: Update, message_id: str) -> None:
        """Create a duplicate of an existing message"""
        try:
            original_message = await self.message_service.get_message_by_id(message_id)

            if not original_message:
                if update.callback_query:
                    await update.callback_query.edit_message_text("‚ùå Original message not found")
                return

            # Create duplicate with modified content
            duplicate_content = f"{original_message.content}\n\n[Duplicate - Edit as needed]"
            duplicate_data = MessageCreate(content=duplicate_content)
            new_message = await self.message_service.create_message(duplicate_data)

            text = (
                f"üìã **MESSAGE DUPLICATED SUCCESSFULLY**\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                f"‚úÖ **Duplicate Created**\n\n"
                f"**Original Message:**\n"
                f"‚îú ID: `{original_message.id}`\n"
                f"‚îú Usage: {original_message.usage_count} broadcasts\n"
                f"‚îî Status: {'üü¢ Active' if original_message.is_active else '‚ö™ Inactive'}\n\n"
                f"**New Duplicate:**\n"
                f"‚îú ID: `{new_message.id}`\n"
                f"‚îú Status: üü¢ **Active & Ready**\n"
                f"‚îú Usage: üìä 0 broadcasts (new)\n"
                f"‚îî Note: Contains '[Duplicate - Edit as needed]' marker\n\n"
                f"üí° **Next Steps:**\n"
                f"‚Ä¢ Edit the duplicate to customize content\n"
                f"‚Ä¢ Remove the duplicate marker text\n"
                f"‚Ä¢ Use both messages for A/B testing"
            )

            keyboard = [
                [
                    InlineKeyboardButton(
                        "‚úèÔ∏è Edit Duplicate", callback_data=f"messages_edit_{new_message.id}"
                    ),
                    InlineKeyboardButton("üìù View All", callback_data="messages_menu"),
                ],
                [InlineKeyboardButton("üè† Dashboard", callback_data="dashboard")],
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            if update.callback_query:
                await update.callback_query.edit_message_text(
                    text, parse_mode="Markdown", reply_markup=reply_markup
                )

        except Exception as e:
            logger.error(f"Error duplicating message: {e}")
            if update.callback_query:
                await update.callback_query.edit_message_text("‚ùå Failed to duplicate message")

    async def _show_advanced_options(
        self, update: Update, _context: ContextTypes.DEFAULT_TYPE
    ) -> None:
        """Show advanced message management options"""
        text = (
            "‚öôÔ∏è **ADVANCED MESSAGE OPTIONS**\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            "üîß **Advanced Features:**\n\n"
            "**Content Management:**\n"
            "‚îú Message templates and presets\n"
            "‚îú Content validation and optimization\n"
            "‚îú Automatic content suggestions\n"
            "‚îî Message performance prediction\n\n"
            "**Scheduling & Automation:**\n"
            "‚îú Time-based message activation\n"
            "‚îú Conditional message rules\n"
            "‚îú Automated content rotation\n"
            "‚îî Smart delivery optimization\n\n"
            "**Analytics & Insights:**\n"
            "‚îú Deep performance analytics\n"
            "‚îú A/B testing framework\n"
            "‚îú Audience response tracking\n"
            "‚îî Content effectiveness scoring\n\n"
            "**Integration Features:**\n"
            "‚îú External content sources\n"
            "‚îú API-based message updates\n"
            "‚îú Webhook notifications\n"
            "‚îî Third-party tool integration\n\n"
            "üí° **Note:** Some features may require additional setup or premium access."
        )

        keyboard = [
            [
                InlineKeyboardButton("üìã Message Templates", callback_data="messages_templates"),
                InlineKeyboardButton(
                    "ü§ñ Auto Optimization", callback_data="messages_auto_optimize"
                ),
            ],
            [
                InlineKeyboardButton("üìä Deep Analytics", callback_data="messages_deep_analytics"),
                InlineKeyboardButton("üß™ A/B Testing", callback_data="messages_ab_testing"),
            ],
            [
                InlineKeyboardButton("‚è∞ Scheduling", callback_data="messages_scheduling"),
                InlineKeyboardButton("üîó Integrations", callback_data="messages_integrations"),
            ],
            [
                InlineKeyboardButton("üîô Back to Messages", callback_data="messages_menu"),
                InlineKeyboardButton("üè† Dashboard", callback_data="dashboard"),
            ],
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        if update.callback_query:
            await update.callback_query.edit_message_text(
                text, parse_mode="Markdown", reply_markup=reply_markup
            )

    async def _send_error_message(self, update: Update, error_text: str) -> None:
        """Enhanced error message handling"""
        error_msg = (
            f"‚ùå **MESSAGE SYSTEM ERROR**\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            f"**Issue:** {error_text}\n\n"
            f"üîß **Troubleshooting Steps:**\n"
            f"‚îú Refresh the interface with `/menu`\n"
            f"‚îú Check your internet connection\n"
            f"‚îú Verify system status with `/status`\n"
            f"‚îú Try the operation again\n"
            f"‚îî Contact support if issue persists\n\n"
            f"üí° **Quick Actions:**"
        )

        keyboard = [
            [
                InlineKeyboardButton("üîÑ Refresh Messages", callback_data="messages_menu"),
                InlineKeyboardButton("üìä System Status", callback_data="refresh_status"),
            ],
            [
                InlineKeyboardButton("üí¨ Get Help", callback_data="help_center"),
                InlineKeyboardButton("üè† Dashboard", callback_data="dashboard"),
            ],
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        if update.message:
            await update.message.reply_text(
                error_msg, parse_mode="Markdown", reply_markup=reply_markup
            )
        elif update.callback_query:
            await update.callback_query.edit_message_text(
                error_msg, parse_mode="Markdown", reply_markup=reply_markup
            )
